<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeLamp Dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a1a; color: #e5e5e5;
    line-height: 1.5; padding: 1rem;
  }

  h1 { text-align: center; margin-bottom: 1rem; font-size: 1.5rem; }
  h1 span { color: #f47a2e; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 1rem; max-width: 1200px; margin: 0 auto;
  }

  .card {
    background: #242424; border-radius: 12px; padding: 1.25rem;
    border: 1px solid #333;
  }
  .card h2 {
    font-size: 1rem; margin-bottom: 0.75rem; color: #f47a2e;
    border-bottom: 1px solid #333; padding-bottom: 0.5rem;
  }

  /* Buttons */
  .btn {
    display: inline-block; padding: 0.4rem 0.75rem;
    background: #333; color: #e5e5e5; border: 1px solid #444;
    border-radius: 6px; cursor: pointer; font-size: 0.85rem;
    transition: background 0.15s, border-color 0.15s;
  }
  .btn:hover { background: #444; border-color: #555; }
  .btn:active { background: #555; }
  .btn.accent { background: #f47a2e; color: #fff; border-color: #f47a2e; }
  .btn.accent:hover { background: #d9681f; border-color: #d9681f; }
  .btn.danger { background: #c0392b; border-color: #c0392b; color: #fff; }
  .btn.danger:hover { background: #a93226; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-group { display: flex; flex-wrap: wrap; gap: 0.4rem; }

  /* Status dot */
  .status-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
  .dot {
    width: 12px; height: 12px; border-radius: 50%;
    flex-shrink: 0; transition: background 0.3s;
  }
  .dot.active { background: #2ecc71; }
  .dot.sleeping { background: #f39c12; }

  /* Select */
  select {
    background: #333; color: #e5e5e5; border: 1px solid #444;
    border-radius: 6px; padding: 0.4rem 0.5rem; font-size: 0.85rem;
    width: 100%;
  }

  /* Color picker row */
  .color-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
  input[type="color"] {
    width: 48px; height: 36px; border: 1px solid #444;
    border-radius: 6px; background: #333; cursor: pointer; padding: 2px;
  }

  /* Sliders */
  .motor-row {
    display: flex; align-items: center; gap: 0.5rem;
    margin-bottom: 0.5rem; font-size: 0.85rem;
  }
  .motor-row label { width: 100px; flex-shrink: 0; }
  .motor-row input[type="range"] { flex: 1; accent-color: #f47a2e; }
  .motor-row .val { width: 50px; text-align: right; font-variant-numeric: tabular-nums; }

  /* Camera */
  .snapshot-container { text-align: center; }
  .snapshot-container img {
    max-width: 100%; border-radius: 8px; border: 1px solid #333;
    margin-top: 0.5rem; display: none;
  }

  /* Auto-refresh row */
  .auto-refresh-row {
    display: flex; align-items: center; gap: 0.5rem;
    font-size: 0.85rem; cursor: pointer; margin-bottom: 0.5rem;
  }
  .auto-refresh-row select {
    width: auto; padding: 0.2rem 0.4rem; font-size: 0.8rem;
  }

  /* Toast */
  #toast-container {
    position: fixed; top: 1rem; right: 1rem; z-index: 9999;
    display: flex; flex-direction: column; gap: 0.5rem;
  }
  .toast {
    background: #c0392b; color: #fff; padding: 0.6rem 1rem;
    border-radius: 8px; font-size: 0.85rem; opacity: 0;
    animation: fadeInOut 3s ease forwards;
  }
  @keyframes fadeInOut {
    0%   { opacity: 0; transform: translateY(-8px); }
    10%  { opacity: 1; transform: translateY(0); }
    80%  { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Idle selector row */
  .idle-row { margin-top: 0.75rem; }
  .idle-row label { font-size: 0.85rem; display: block; margin-bottom: 0.3rem; color: #aaa; }

  /* Text input */
  input[type="text"] {
    background: #333; color: #e5e5e5; border: 1px solid #444;
    border-radius: 6px; padding: 0.4rem 0.5rem; font-size: 0.85rem;
    flex: 1; min-width: 0;
  }
  input[type="text"]:disabled { opacity: 0.4; }

  /* Recording indicator */
  .rec-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #c0392b; display: inline-block;
    animation: pulse 1s ease infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }
</style>
</head>
<body>

<h1><span>LeLamp</span> Dashboard</h1>

<div class="grid">

  <!-- Agent Status -->
  <div class="card">
    <h2>Agent Status</h2>
    <div class="status-row">
      <div class="dot active" id="status-dot"></div>
      <span id="status-text">Active</span>
    </div>
    <div class="btn-group">
      <button class="btn danger" id="btn-sleep" onclick="agentSleep()">Sleep</button>
      <button class="btn accent" id="btn-wake" onclick="agentWake()" disabled>Wake Up</button>
    </div>
  </div>

  <!-- Servo Animations -->
  <div class="card">
    <h2>Servo Animations</h2>
    <div class="btn-group" id="anim-buttons"></div>
    <div style="margin-top:0.75rem">
      <button class="btn danger" onclick="stopServo()">Stop</button>
    </div>
    <div class="idle-row">
      <label>Idle Animation</label>
      <select id="idle-select" onchange="setIdle(this.value)">
        <option value="">None</option>
      </select>
    </div>
  </div>

  <!-- Record Animation -->
  <div class="card">
    <h2>Record Animation</h2>
    <div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem;">
      <input type="text" id="rec-name" placeholder="animation name">
      <button class="btn accent" id="btn-rec-start" onclick="startRec()">Record</button>
      <button class="btn danger" id="btn-rec-stop" onclick="stopRec()" disabled>Stop</button>
    </div>
    <div id="rec-status" style="font-size:0.85rem; color:#aaa;"></div>
  </div>

  <!-- RGB Controls -->
  <div class="card">
    <h2>RGB Controls</h2>
    <div class="color-row">
      <input type="color" id="color-picker" value="#f47a2e">
      <button class="btn accent" onclick="setColor()">Set Color</button>
      <button class="btn danger" onclick="stopRgb()">Stop RGB</button>
    </div>
    <div class="btn-group" id="rgb-buttons"></div>
  </div>

  <!-- Motor Control -->
  <div class="card">
    <h2>Motor Control</h2>
    <div id="motor-sliders"></div>
    <div style="margin-top:0.5rem; display:flex; align-items:center; gap:0.75rem;">
      <button class="btn" onclick="readPositions()">Read Positions</button>
      <label class="auto-refresh-row" style="margin-bottom:0">
        <input type="checkbox" id="motor-auto" checked> Auto
        <select id="motor-interval">
          <option value="500">0.5s</option>
          <option value="1000" selected>1s</option>
          <option value="2000">2s</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Camera -->
  <div class="card" id="camera-card">
    <h2>Camera</h2>
    <div class="snapshot-container">
      <label class="auto-refresh-row">
        <input type="checkbox" id="cam-auto" checked> Auto-refresh
        <select id="cam-interval">
          <option value="1000">1s</option>
          <option value="2000" selected>2s</option>
          <option value="5000">5s</option>
        </select>
      </label>
      <img id="snapshot" alt="Camera snapshot">
    </div>
  </div>

</div>

<div id="toast-container"></div>

<script>
// ---- API helpers ----
async function api(path, opts = {}) {
  try {
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts,
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
    return data;
  } catch (e) {
    toast(e.message);
    throw e;
  }
}
function post(path, body) {
  return api(path, { method: 'POST', body: JSON.stringify(body) });
}
function toast(msg) {
  const el = document.createElement('div');
  el.className = 'toast'; el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ---- Agent ----
async function pollStatus() {
  try {
    const d = await api('/api/agent/status');
    const dot = document.getElementById('status-dot');
    const txt = document.getElementById('status-text');
    const btnS = document.getElementById('btn-sleep');
    const btnW = document.getElementById('btn-wake');
    if (d.is_sleeping) {
      dot.className = 'dot sleeping'; txt.textContent = 'Sleeping';
      btnS.disabled = true; btnW.disabled = false;
    } else {
      dot.className = 'dot active'; txt.textContent = 'Active';
      btnS.disabled = false; btnW.disabled = true;
    }
  } catch {}
}
async function agentSleep() { await post('/api/agent/sleep', {}); pollStatus(); }
async function agentWake()  { await post('/api/agent/wake', {});  pollStatus(); }

// ---- Servo Animations ----
async function initAnimations() {
  try {
    const d = await api('/api/animations');
    const container = document.getElementById('anim-buttons');
    const select = document.getElementById('idle-select');
    container.innerHTML = '';
    select.innerHTML = '<option value="">None</option>';
    d.animations.forEach(name => {
      const btn = document.createElement('button');
      btn.className = 'btn'; btn.textContent = name;
      btn.onclick = () => post('/api/animations/play', { name });
      container.appendChild(btn);
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      if (name === d.current_idle) opt.selected = true;
      select.appendChild(opt);
    });
    if (!d.current_idle) select.value = '';
  } catch {}
}
async function stopServo() { await post('/api/animations/stop', {}); }
async function setIdle(name) { await post('/api/animations/idle', { name: name || null }); }

// ---- RGB ----
const RGB_ANIMS = ['rainbow', 'breathing', 'flowing', 'sparkle', 'police'];
function initRgb() {
  const container = document.getElementById('rgb-buttons');
  RGB_ANIMS.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'btn'; btn.textContent = name;
    btn.onclick = () => post('/api/rgb/animation', { name });
    container.appendChild(btn);
  });
}
async function setColor() {
  const hex = document.getElementById('color-picker').value;
  const r = parseInt(hex.slice(1,3), 16);
  const g = parseInt(hex.slice(3,5), 16);
  const b = parseInt(hex.slice(5,7), 16);
  await post('/api/rgb/solid', { r, g, b });
}
async function stopRgb() { await post('/api/rgb/stop', {}); }

// ---- Motors ----
const MOTORS = ['base_yaw', 'base_pitch', 'elbow_pitch', 'wrist_roll', 'wrist_pitch'];
let motorThrottleTimer = null;

function initMotors() {
  const container = document.getElementById('motor-sliders');
  MOTORS.forEach(name => {
    const row = document.createElement('div');
    row.className = 'motor-row';
    row.innerHTML =
      `<label>${name}</label>` +
      `<input type="range" min="-100" max="100" value="0" id="slider-${name}">` +
      `<span class="val" id="val-${name}">0</span>`;
    container.appendChild(row);
    const slider = row.querySelector('input');
    const valSpan = row.querySelector('.val');
    slider.addEventListener('mousedown', () => { motorUserDragging = true; });
    slider.addEventListener('touchstart', () => { motorUserDragging = true; });
    slider.addEventListener('mouseup', () => { motorUserDragging = false; });
    slider.addEventListener('touchend', () => { motorUserDragging = false; });
    slider.addEventListener('input', () => {
      valSpan.textContent = slider.value;
      throttledWriteMotors();
    });
  });
}

function throttledWriteMotors() {
  if (motorThrottleTimer) return;
  motorThrottleTimer = setTimeout(() => {
    motorThrottleTimer = null;
    const positions = {};
    MOTORS.forEach(name => {
      positions[name] = parseFloat(document.getElementById(`slider-${name}`).value);
    });
    post('/api/motors/positions', { positions }).catch(() => {});
  }, 100);
}

let motorAutoTimer = null;
let motorUserDragging = false;

async function readPositions() {
  if (motorUserDragging) return;
  try {
    const d = await api('/api/motors/positions');
    MOTORS.forEach(name => {
      if (d.positions[name] !== undefined) {
        const v = Math.round(d.positions[name] * 10) / 10;
        document.getElementById(`slider-${name}`).value = v;
        document.getElementById(`val-${name}`).textContent = v;
      }
    });
  } catch {}
}

function startMotorAutoRefresh() {
  stopMotorAutoRefresh();
  if (!document.getElementById('motor-auto').checked) return;
  const ms = parseInt(document.getElementById('motor-interval').value);
  motorAutoTimer = setInterval(readPositions, ms);
}
function stopMotorAutoRefresh() {
  if (motorAutoTimer) { clearInterval(motorAutoTimer); motorAutoTimer = null; }
}

// ---- Camera ----
let camTimer = null;
async function refreshSnapshot() {
  try {
    const d = await api('/api/camera/snapshot');
    const img = document.getElementById('snapshot');
    img.src = d.image; img.style.display = 'block';
  } catch {}
}
function startCamAutoRefresh() {
  stopCamAutoRefresh();
  const enabled = document.getElementById('cam-auto').checked;
  if (!enabled) return;
  const ms = parseInt(document.getElementById('cam-interval').value);
  refreshSnapshot();
  camTimer = setInterval(refreshSnapshot, ms);
}
function stopCamAutoRefresh() {
  if (camTimer) { clearInterval(camTimer); camTimer = null; }
}
function initCamera() {
  document.getElementById('cam-auto').addEventListener('change', startCamAutoRefresh);
  document.getElementById('cam-interval').addEventListener('change', startCamAutoRefresh);
  startCamAutoRefresh();
}

// ---- Recording ----
let recTimer = null;
let recStartTime = 0;

function setRecordingUI(active) {
  document.getElementById('btn-rec-start').disabled = active;
  document.getElementById('btn-rec-stop').disabled = !active;
  document.getElementById('rec-name').disabled = active;
  // Pause motor auto-refresh and slider writes during recording to avoid serial conflicts
  document.querySelectorAll('#motor-sliders input').forEach(i => i.disabled = active);
  if (active) stopMotorAutoRefresh(); else startMotorAutoRefresh();
}

async function startRec() {
  const name = document.getElementById('rec-name').value.trim();
  if (!name) { toast('Enter an animation name'); return; }
  try {
    await post('/api/recording/start', { name });
    setRecordingUI(true);
    recStartTime = Date.now();
    document.getElementById('rec-status').innerHTML =
      '<span class="rec-dot"></span> Recording...';
    recTimer = setInterval(() => {
      const s = ((Date.now() - recStartTime) / 1000).toFixed(1);
      document.getElementById('rec-status').innerHTML =
        `<span class="rec-dot"></span> Recording... ${s}s`;
    }, 100);
  } catch {}
}

async function stopRec() {
  try {
    const d = await post('/api/recording/stop', {});
    setRecordingUI(false);
    clearInterval(recTimer);
    document.getElementById('rec-status').textContent =
      `Saved ${d.name}.csv (${d.frames} frames, ${d.duration}s)`;
    initAnimations();
  } catch {}
}

async function initRecording() {
  try {
    const d = await api('/api/recording/status');
    if (d.recording) {
      setRecordingUI(true);
      recStartTime = Date.now();
      recTimer = setInterval(() => {
        const s = ((Date.now() - recStartTime) / 1000).toFixed(1);
        document.getElementById('rec-status').innerHTML =
          `<span class="rec-dot"></span> Recording... ${s}s`;
      }, 100);
    }
  } catch {}
}

// ---- Init ----
initAnimations();
initRgb();
initMotors();
readPositions();
document.getElementById('motor-auto').addEventListener('change', startMotorAutoRefresh);
document.getElementById('motor-interval').addEventListener('change', startMotorAutoRefresh);
startMotorAutoRefresh();
pollStatus();
initCamera();
initRecording();
setInterval(pollStatus, 5000);
</script>
</body>
</html>
