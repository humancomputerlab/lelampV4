# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

LeLamp V4 is a conversational AI-powered robotic lamp for Raspberry Pi. It combines voice interaction (OpenAI Realtime API), servo motor control (5-joint arm), RGB LED lighting (93 NeoPixels), and computer vision (webcam) into an expressive robot with a personality system.

## Commands

```bash
# Install all dependencies (Raspberry Pi setup, udev rules, motor IDs, calibration)
bash install.sh

# Install Python dependencies only
uv sync

# Run the application (requires OPENAI_API_KEY in env or .env)
uv run main.py

# Interactive servo calibration
uv run python calibrate_servo.py
```

There is no test suite. Individual modules can be tested via their `if __name__ == "__main__"` blocks (e.g., `uv run python servo_controller.py`).

## Architecture

**Async-first design** — all components use asyncio. `main.py` orchestrates initialization in sequence: servo controller → RGB controller → LLM agent → vision controller → idle animation → start voice loop.

### Core Components

- **`llm.py`** — Two classes: `Agent` (tool registry, system prompt assembly, tool execution) and `LLM` (OpenAI Realtime WebSocket connection, audio I/O via sounddevice at 24kHz PCM16 mono, vision image injection). The Agent builds its system prompt dynamically by combining a base voice-first instruction, available animation names, the personality template, and vision guidelines.

- **`tools.py`** — Functions decorated with `@tool` that the LLM can call. Each tool receives `agent` as its first argument to access controllers. Tools cover servo playback, RGB control, and vision capture. Tool docstrings serve as the function descriptions sent to OpenAI.

- **`servo_controller.py`** — Controls 5 Feetech STS3215 servos via `/dev/lelamp` (udev symlink). Motor IDs 1-5: base_yaw, base_pitch, elbow_pitch, wrist_roll, wrist_pitch. Uses lerobot's FeetechMotorsBus. Animations are CSV files played through an async queue with interrupt support and idle animation looping.

- **`rgb_controller.py`** — Drives 93 NeoPixel LEDs on GPIO pin 10 at 30% brightness. Built-in animations: rainbow, breathing, flowing, sparkle, police. Async animation runner with duration and background fallback.

- **`vision_controller.py`** — OpenCV camera capture at configurable FPS (default 1.0), 640x480 JPEG base64-encoded. Non-blocking via executor. The LLM's `get_scene` tool triggers image capture and injects it directly into the Realtime API conversation as `input_image`.

### Personality System

`personality/instructions.txt` is a template with `{robot_name}`, `{description}`, `{speech_style}`, `{ideals}`, `{flaws}`, `{bio}` placeholders filled from `personality/characters/LeLamp.json` using Python's `str.format()`. Double braces `{{ }}` are needed for literal braces in the template.

### Animation Format

Servo animations are CSVs in `servo_animations/` with columns: `timestamp, base_yaw.pos, base_pitch.pos, elbow_pitch.pos, wrist_roll.pos, wrist_pitch.pos`. Positions are normalized values. Default playback at 30 FPS.

## Key Configuration

- **`lelamp.json`** — Local motor calibration data (homing offsets, range limits). Generated by `install.sh` or `calibrate_servo.py`.
- **`.env`** — Must contain `OPENAI_API_KEY`.
- **Audio** — Requires PipeWire; the LLM class searches for a PipeWire device by name and will raise if not found.
- **Python** — Requires >=3.11. Package management via `uv`.

## Robot Model (`my_robot/`)

URDF robot description and 3D assets exported from Onshape via `onshape-to-robot`. Contains the full kinematic chain: `base_plate` → `base_subassembly` (servo1, yaw) → `bottom_link_subassembly` (servo2, pitch) → `top_link_subassembly` (servo3, elbow) → `head_link_subassembly` (servo4, wrist roll) → `head_subassembly` (servo5, wrist pitch). STL meshes and `.part` files in `my_robot/assets/`. `config.json` holds the Onshape document/workspace/element IDs for re-export.

## Hardware Requirements

Raspberry Pi with: Waveshare Servo Bus Adapter (mapped to `/dev/lelamp` via udev), Feetech STS3215 servos, WS2812B/NeoPixel LED strip on GPIO 10, USB webcam, PipeWire-compatible audio device.
